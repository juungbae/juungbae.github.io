---
layout: post
title: "📚 SQLAlchemy 세션 캐시 문제 해결"
date: 2021-02-01 01:23:43 +0900
categories: issue
---

개발하고 있는 토이 프로젝트가 시간과 관련된 프로젝트라, 서버에서 사용자가 선택한 시간에 푸시를 보내는 피쳐가 필요해졌다. 서버가 람다로 구성되어 있어서, 특정 시간에 예약된 알람을 전송하는 잡을 1분에 한번씩 돌도록 만들었다.

잡도 문제없이 돌았고, 예약도 정상적으로 진행되었지만 높은 확률로 쿼리가 비어 왔다. 높은 확률이라는 게 가끔은 정상적으로 작동하는데 대부분의 경우 정상적으로 작동하지 않는 문제였다. `SQLAlchemy` 에서 생성되는 쿼리에 문제가 있나 싶어서 뜯어봤지만 정상적으로 생성되고 있었다.

혹시 timezone 문제가 아닐까 했는데, 타임존 문제도 아니었다. 해당 워커가 다른 데이터베이스 ( 프로덕션이 아닌 디벨롭 ) 를 보고 있는건 아닌가 싶어서 다른 걸 봤는데 그것도 아니었다. 그럼 진짜 어디선가 잘못되고 있다는 건데. 쿼리를 잘 날리는데 결과가 안 오는건 대체 무슨 문제일까?

```python
@lru_cache()
def new_session(config: Config) -> Session:
    factory = sessionmaker(bind=database_engine(config), autocommit=False, autoflush=False)
    return factory()
```

문제가 된 코드이다. 해당 코드로 세션을 만드는 다른 워커들이 있어서 문제가 아닐거라고 생각했지만, 실제로 `lru_cache` 어노테이션을 삭제했을 때 정상적으로 작동하는 모습을 보였다.

SQLAlchemy에서는 세션을 생성할 때, transaction에서 스냅샷을 뜬다. 문제는 지금 위 코드가 세션메이커가 아닌 세션 객체 자체를 캐시하고 있다는 점인데, 적절한 시간 간격을 두고 실행되는 워커에서는 ( 람다 인스턴스가 죽어서 콜드스타드를 하게 되는 5분 이후 ) 적절히 스냅샷이 갱신되어 세션이 문제없이 작동하였다.

하지만 이번 워커같은 경우는 1분에 한번 실행하기 때문에 람다 인스턴스가 그대로 있고, 그 상태에서 인스턴스가 처음 실행된 상태의 세션을 계속 가져다 써서 오류가 생긴 것으로 보인다.
